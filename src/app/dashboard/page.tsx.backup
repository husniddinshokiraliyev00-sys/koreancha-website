'use client';

import { useEffect, useMemo, useRef, useState } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';

import { useLanguage, type Lang, useUser } from '../providers';

type Plan = 'free' | 'premium';

type Activity = {
  title: string;
  icon: 'book' | 'headphones' | 'file' | 'pencil' | 'star' | 'timer' | 'mic';
  limitKey?: 'limitedPerDay' | 'limitedAccess';
};

const activities: Activity[] = [
  { title: 'Learn Vocabulary', icon: 'book', limitKey: 'limitedPerDay' },
  { title: 'Listening Practice', icon: 'headphones', limitKey: 'limitedPerDay' },
  { title: 'Reading Practice', icon: 'file', limitKey: 'limitedPerDay' },
  { title: 'Writing Practice', icon: 'pencil', limitKey: 'limitedPerDay' },
  { title: 'TOPIK Samples', icon: 'star', limitKey: 'limitedAccess' },
  { title: 'Full Mock', icon: 'timer', limitKey: 'limitedAccess' },
  { title: 'Speaking Practice', icon: 'mic', limitKey: 'limitedPerDay' }
];

type DashboardTranslations = {
  welcome: string;
  dashboardTitle: string;
  overallStats: string;
  totalCardsStudied: string;
  masteryRate: string;
  currentStreak: string;
  topikLevel: string;
  masteryByUnit: string;
  recentActivity: string;
  noActivity: string;
  daysAgo: string;
  today: string;
  yesterday: string;
  premium: string;
  free: string;
  logout: string;
  upgrade: string;
  activities: string;
  unlimited: string;
  limitedPerDay: string;
  limitedAccess: string;
  flashcardsProgressTitle: string;
  flashcardsProgressDesc: string;
  continue: string;
  noFlashcardsProgress: string;
  guestMode: string;
  loginRequired: string;
  signIn: string;
};

const translations: Record<Lang, DashboardTranslations> = {
  uz: {
    welcome: 'Xush kelibsiz',
    dashboardTitle: 'Progress Dashboard',
    overallStats: 'Umumiy statistika',
    totalCardsStudied: 'Jami o\'rganilgan kartalar',
    masteryRate: 'Ustalik darajasi',
    currentStreak: 'Joriy seriya',
    topikLevel: 'TOPIK darajasi',
    masteryByUnit: 'Bo\'limlar bo\'yicha ustalik',
    recentActivity: 'So\'nggi faoliyat',
    noActivity: 'Faoliyat yo\'q',
    daysAgo: 'kun oldin',
    today: 'Bugun',
    yesterday: 'Kecha',
    premium: 'Premium',
    free: 'Bepul',
    logout: 'Chiqish',
    upgrade: 'Yangilash',
    activities: 'Faoliyatlar',
    unlimited: 'Cheksiz',
    limitedPerDay: 'Kuniga cheklangan',
    limitedAccess: 'Cheklangan kirish',
    flashcardsProgressTitle: 'Flashcard progress',
    flashcardsProgressDesc: 'Continue learning where you left off',
    continue: 'Davom eting',
    noFlashcardsProgress: 'No flashcard progress yet',
    guestMode: 'Mehmon rejimi',
    loginRequired: 'To\'liq statistika uchun tizimga kiring',
    signIn: 'Kirish'
  },
  ru: {
    welcome: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å',
    dashboardTitle: '–ü–∞–Ω–µ–ª—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞',
    overallStats: '–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞',
    totalCardsStudied: '–í—Å–µ–≥–æ –∏–∑—É—á–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫',
    masteryRate: '–£—Ä–æ–≤–µ–Ω—å –≤–ª–∞–¥–µ–Ω–∏—è',
    currentStreak: '–¢–µ–∫—É—â–∞—è —Å–µ—Ä–∏—è',
    topikLevel: '–£—Ä–æ–≤–µ–Ω—å TOPIK',
    masteryByUnit: '–í–ª–∞–¥–µ–Ω–∏–µ –ø–æ —é–Ω–∏—Ç–∞–º',
    recentActivity: '–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
    noActivity: '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
    daysAgo: '–¥–Ω–µ–π –Ω–∞–∑–∞–¥',
    today: '–°–µ–≥–æ–¥–Ω—è',
    yesterday: '–í—á–µ—Ä–∞',
    premium: '–ü—Ä–µ–º–∏—É–º',
    free: '–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π',
    logout: '–í—ã–π—Ç–∏',
    upgrade: '–û–±–Ω–æ–≤–∏—Ç—å',
    activities: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
    unlimited: '–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π',
    limitedPerDay: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –≤ –¥–µ–Ω—å',
    limitedAccess: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø',
    flashcardsProgressTitle: '–ü—Ä–æ–≥—Ä–µ—Å—Å –∫–∞—Ä—Ç–æ—á–µ–∫',
    flashcardsProgressDesc: '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –æ–±—É—á–µ–Ω–∏–µ —Å —Ç–æ–≥–æ –º–µ—Å—Ç–∞, –≥–¥–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å',
    continue: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
    noFlashcardsProgress: '–ü—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º –ø–æ–∫–∞ –Ω–µ—Ç',
    guestMode: '–ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º',
    loginRequired: '–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏',
    signIn: '–í–æ–π—Ç–∏'
  },
  en: {
    welcome: 'Welcome',
    dashboardTitle: 'Progress Dashboard',
    overallStats: 'Overall Statistics',
    totalCardsStudied: 'Total Cards Studied',
    masteryRate: 'Mastery Rate',
    currentStreak: 'Current Streak',
    topikLevel: 'TOPIK Level',
    masteryByUnit: 'Mastery by Unit',
    recentActivity: 'Recent Activity',
    noActivity: 'No activity',
    daysAgo: 'days ago',
    today: 'Today',
    yesterday: 'Yesterday',
    premium: 'Premium',
    free: 'Free',
    logout: 'Logout',
    upgrade: 'Upgrade',
    activities: 'Activities',
    unlimited: 'Unlimited',
    limitedPerDay: 'Limited per day',
    limitedAccess: 'Limited access',
    flashcardsProgressTitle: 'Flashcard progress',
    flashcardsProgressDesc: 'Continue learning where you left off',
    continue: 'Continue',
    upgrade: 'Premiumga o‚Äòtish',
    activities: 'Faoliyatlar',
    unlimited: 'Cheksiz kirish',
    limitedPerDay: 'Kuniga cheklangan',
    limitedAccess: 'Cheklangan kirish',
    flashcardsProgressTitle: 'Flashcards natijalari',
    flashcardsProgressDesc: 'So‚Äòz yodlashdagi progress.',
    continue: 'Davom etish',
    noFlashcardsProgress: 'Hali flashcards progress yo‚Äòq.',
    guestMode: 'Mehmon rejimi',
    loginRequired: 'To‚Äòliq statistika uchun tizimga kiring',
    signIn: 'Kirish'
  },
  ru: {
    welcome: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å',
    dashboardTitle: '–ü–∞–Ω–µ–ª—å',
    dashboardDescPremium: '–£ –≤–∞—Å –±–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º –∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º.',
    dashboardDescFree: '–î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—è–º —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º–∏. –ü–æ–∑–∂–µ –º–æ–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ Premium.',
    premium: 'Premium',
    free: 'Free',
    logout: '–í—ã–π—Ç–∏',
    upgrade: '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ Premium',
    activities: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏',
    unlimited: '–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø',
    limitedPerDay: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –≤ –¥–µ–Ω—å',
    limitedAccess: '–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø',
    flashcardsProgressTitle: '–ü—Ä–æ–≥—Ä–µ—Å—Å Flashcards',
    flashcardsProgressDesc: '–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∏–∑—É—á–µ–Ω–∏—é —Å–ª–æ–≤.',
    continue: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
    noFlashcardsProgress: '–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ flashcards.',
    guestMode: '–ì–æ—Å—Ç–µ–≤–æ–π —Ä–µ–∂–∏–º',
    loginRequired: '–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø–æ–ª–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏',
    signIn: '–í–æ–π—Ç–∏'
  },
  en: {
    welcome: 'Welcome',
    dashboardTitle: 'Dashboard',
    dashboardDescPremium: 'You have unlimited access to all activities and materials.',
    dashboardDescFree: 'You can access all activities with limitations. Upgrade later for unlimited access.',
    premium: 'Premium',
    free: 'Free',
    logout: 'Logout',
    upgrade: 'Upgrade to Premium',
    activities: 'Activities',
    unlimited: 'Unlimited access',
    limitedPerDay: 'Limited per day',
    limitedAccess: 'Limited access',
    flashcardsProgressTitle: 'Flashcards progress',
    flashcardsProgressDesc: 'Your vocabulary learning progress.',
    continue: 'Continue',
    noFlashcardsProgress: 'No flashcards progress yet.',
    guestMode: 'Guest Mode',
    loginRequired: 'Sign in for full statistics',
    signIn: 'Sign In'
  }
};

type FlashcardsProgressV1 = {
  version: 1;
  units: Record<
    string,
    {
      masteredIndices: number[];
      lastIndex: number;
      totalCards: number;
      updatedAt: string;
    }
  >;
};

const FLASHCARDS_PROGRESS_KEY = 'koreancha_flashcards_progress_v1';

const getLangName = (code: Lang) => (code === 'uz' ? "O'Z" : code === 'ru' ? '–†–£' : 'EN');

const renderIcon = (name: Activity['icon']) => {
  const className = 'w-5 h-5';

  switch (name) {
    case 'book':
      return (
        <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M4 19a2 2 0 0 0 2 2h12" />
          <path d="M6 3h12a2 2 0 0 1 2 2v16" />
          <path d="M6 3a2 2 0 0 0-2 2v14a2 2 0 0 1 2-2h12" />
        </svg>
      );
    case 'headphones':
      return (
        <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M4 13a8 8 0 0 1 16 0" />
          <path d="M4 13v6a2 2 0 0 0 2 2h1v-8H6a2 2 0 0 0-2 2" />
          <path d="M20 13v6a2 2 0 0 1-2 2h-1v-8h1a2 2 0 0 1 2 2" />
        </svg>
      );
    case 'file':
      return (
        <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <path d="M14 2v6h6" />
        </svg>
      );
    case 'pencil':
      return (
        <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M12 20h9" />
          <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4Z" />
        </svg>
      );
    case 'star':
      return (
        <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M12 17.27 18.18 21 16.54 13.97 22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
        </svg>
      );
    case 'timer':
      return (
        <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M10 2h4" />
          <path d="M12 14v-4" />
          <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>
      );
    case 'mic':
      return (
        <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3Z" />
          <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
          <path d="M12 19v4" />
          <path d="M8 23h8" />
        </svg>
      );
  }
};

const getPlanFromUser = (user: User | null): Plan => {
  const anyUser: any = user;
  const plan = anyUser?.user_metadata?.plan;
  const isPremium = anyUser?.user_metadata?.is_premium;

  if (plan === 'premium' || isPremium === true) return 'premium';
  return 'free';
};

export default function DashboardPage() {
  const { lang, setLang } = useLanguage();
  const { user, profile, stats, loading, isPremium, canAccessFeature, logActivity } = useUser();
  const supabase = useSupabase();
  const router = useRouter();

  const ui = useMemo(() => translations[lang], [lang]);
  const t = ui;

  const [flashcardsProgress, setFlashcardsProgress] = useState<FlashcardsProgressV1 | null>(null);
  const [showLangDropdown, setShowLangDropdown] = useState(false);
  const langDropdownRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    try {
      const raw = localStorage.getItem(FLASHCARDS_PROGRESS_KEY);
      if (!raw) {
        setFlashcardsProgress(null);
        return;
      }
      const parsed = JSON.parse(raw) as FlashcardsProgressV1;
      if (!parsed || parsed.version !== 1 || !parsed.units) {
        setFlashcardsProgress(null);
        return;
      }
      setFlashcardsProgress(parsed);
    } catch {
      setFlashcardsProgress(null);
    }
  }, []);

  const flashcardsUnits = useMemo(() => {
    if (!flashcardsProgress?.units) return [];

    return Object.entries(flashcardsProgress.units)
      .map(([unit, u]) => {
        const total = typeof u.totalCards === 'number' ? u.totalCards : 0;
        const masteredCount = Array.isArray(u.masteredIndices) ? u.masteredIndices.length : 0;
        const updatedAt = typeof u.updatedAt === 'string' ? u.updatedAt : '';
        const lastIndex = typeof u.lastIndex === 'number' ? u.lastIndex : 0;
        return { unit, total, masteredCount, updatedAt, lastIndex };
      })
      .filter((u) => u.total > 0)
      .sort((a, b) => (b.updatedAt || '').localeCompare(a.updatedAt || ''));
  }, [flashcardsProgress]);

  const mostRecentFlashcardsUnit = flashcardsUnits[0] || null;

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (langDropdownRef.current && !langDropdownRef.current.contains(event.target as Node)) {
        setShowLangDropdown(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => {
      document.removeEventListener('mousedown', handleClickOutside);
    };
  }, []);

  const handleLangChange = (newLang: Lang) => {
    setLang(newLang);
  };

  const handleSignOut = async () => {
    await supabase.auth.signOut();
    router.replace('/login');
  };

  if (loading || !user) {
    return (
      <main className="min-h-screen bg-gray-50 flex items-center justify-center p-6">
        <div className="text-gray-700 font-semibold">Loading...</div>
      </main>
    );
  }

  const displayName = profile?.full_name || user?.email || 'User';
  const plan = isPremium ? 'premium' : 'free';

  return (
    <main className="min-h-screen bg-gray-50">
      <header className="bg-gray-900 text-white">
        <div className="max-w-6xl mx-auto px-6 py-5 flex items-center justify-between gap-4">
          <div>
            <div className="text-sm text-white/80">{t.welcome}</div>
            <div className="text-xl font-bold">{displayName}</div>
          </div>

          <div className="flex items-center gap-3">
            <div className="relative" ref={langDropdownRef}>
              <button
                type="button"
                onClick={() => setShowLangDropdown((v) => !v)}
                className="flex items-center gap-1.5 px-3 py-2 rounded-lg bg-white/10 hover:bg-white/20 transition"
              >
                <span className="text-sm font-semibold text-white">{getLangName(lang)}</span>
                <svg
                  className={`w-4 h-4 text-white/80 transition-transform ${showLangDropdown ? 'rotate-180' : ''}`}
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                </svg>
              </button>

              {showLangDropdown && (
                <div className="absolute right-0 mt-2 w-28 bg-white rounded-lg shadow-xl py-1 z-50 border border-gray-100">
                  {(['uz', 'ru', 'en'] as Lang[]).map((code) => (
                    <button
                      key={code}
                      type="button"
                      onClick={() => {
                        handleLangChange(code);
                        setShowLangDropdown(false);
                      }}
                      className={`w-full text-left px-3 py-2 text-sm transition hover:bg-gray-50 ${
                        lang === code ? 'bg-blue-50 text-blue-700 font-semibold' : 'text-gray-700'
                      }`}
                    >
                      {getLangName(code)}
                    </button>
                  ))}
                </div>
              )}
            </div>

            <div
              className={`px-3 py-1 rounded-full text-sm font-semibold border ${
                plan === 'premium'
                  ? 'bg-yellow-400/10 border-yellow-400/40 text-yellow-200'
                  : 'bg-white/10 border-white/20 text-white'
              }`}
            >
              {plan === 'premium' ? t.premium : t.free}
            </div>

            <button
              type="button"
              onClick={handleSignOut}
              className="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg font-semibold transition"
            >
              {t.logout}
            </button>
          </div>
        </div>

        <div className="mt-6 grid grid-cols-1 sm:grid-cols-3 gap-4">
          {/* Streak Widget */}
          <div className="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
            <div className="flex items-center justify-between gap-2">
              <div className="flex-1">
                <div className="text-xs font-semibold text-gray-800">üî• Streak</div>
                <div className="text-xs text-gray-600 mt-1">Daily learning</div>
              </div>
              <div className="text-xl font-bold text-orange-600">{profile?.streak_current || 0}</div>
            </div>
            <div className="mt-2 text-xs text-gray-500">
              Longest: {profile?.streak_longest || 0} days
            </div>
          </div>

          {/* XP Widget */}
          <div className="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
            <div className="flex items-center justify-between gap-2">
              <div className="flex-1">
                <div className="text-xs font-semibold text-gray-800">‚≠ê XP</div>
                <div className="text-xs text-gray-600 mt-1">Experience</div>
              </div>
              <div className="text-xl font-bold text-purple-600">{profile?.xp || 0}</div>
            </div>
            <div className="mt-2 text-xs text-gray-500">
              Level {profile?.level || 1}
            </div>
          </div>

          {/* Stats Widget */}
          <div className="bg-white rounded-xl border border-gray-100 shadow-sm p-4">
            <div className="flex items-center justify-between gap-2">
              <div className="flex-1">
                <div className="text-xs font-semibold text-gray-800">üìä Stats</div>
                <div className="text-xs text-gray-600 mt-1">Progress</div>
              </div>
              <div className="text-xl font-bold text-blue-600">{stats?.flashcards_reviewed || 0}</div>
            </div>
            <div className="mt-2 text-xs text-gray-500">
              Flashcards reviewed
            </div>
          </div>
        </div>

        <div className="mt-6 bg-white rounded-2xl border border-gray-100 shadow-sm p-6">
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div>
              <div className="text-sm font-semibold text-gray-800">{t.flashcardsProgressTitle}</div>
              <div className="mt-1 text-sm text-gray-600">{t.flashcardsProgressDesc}</div>
            </div>

            {mostRecentFlashcardsUnit && (
              <Link
                href={`/flashcards?unit=${encodeURIComponent(mostRecentFlashcardsUnit.unit)}`}
                className="bg-blue-700 hover:bg-blue-800 text-white px-5 py-3 rounded-xl font-bold transition"
              >
                {t.continue}
              </Link>
            )}
          </div>

          {flashcardsUnits.length === 0 ? (
            <div className="mt-4 text-sm text-gray-700">{t.noFlashcardsProgress}</div>
          ) : (
            <div className="mt-6 space-y-3">
              {flashcardsUnits.slice(0, 3).map(({ unit, total, masteredCount, updatedAt }) => {
                const percentage = total > 0 ? Math.round((masteredCount / total) * 100) : 0;
                return (
                  <div key={unit} className="flex items-center justify-between gap-4 p-3 bg-gray-50 rounded-lg">
                    <div className="flex-1">
                      <div className="flex items-center justify-between gap-2">
                        <span className="font-medium text-gray-900">{unit}</span>
                        <span className="text-xs text-gray-500">{masteredCount}/{total}</span>
                      </div>
                      <div className="mt-1 w-full bg-gray-200 rounded-full h-2">
                        <div
                          className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                          style={{ width: `${percentage}%` }}
                        />
                      </div>
                    </div>
                    <div className="text-xs text-gray-500">{percentage}%</div>
                  </div>
                );
              })}
            </div>
          )}
        </div>

        {/* Enhanced Statistics Section */}
        <div className="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Mastery by Unit Chart */}
          <div className="bg-white rounded-2xl border border-gray-100 shadow-sm p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-4">{t.masteryByUnit}</h3>
            {flashcardsUnits.length > 0 ? (
              <ResponsiveContainer width="100%" height={250}>
                <BarChart data={flashcardsUnits.map(({ unit, masteredCount, total }) => ({
                  unit,
                  mastered: masteredCount,
                  total: total - masteredCount
                }))}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="unit" />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="mastered" fill="#3B82F6" name="Mastered" />
                  <Bar dataKey="total" fill="#E5E7EB" name="Remaining" />
                </BarChart>
              </ResponsiveContainer>
            ) : (
              <div className="h-64 flex items-center justify-center text-gray-500">
                {t.noActivity}
              </div>
            )}
          </div>

          {/* Recent Activity */}
          <div className="bg-white rounded-2xl border border-gray-100 shadow-sm p-6">
            <h3 className="text-lg font-semibold text-gray-800 mb-4">{t.recentActivity}</h3>
            <div className="space-y-3">
              {flashcardsUnits.slice(0, 5).map(({ unit, masteredCount, updatedAt }) => {
                const date = new Date(updatedAt);
                const now = new Date();
                const daysDiff = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24));
                
                let timeAgo = t.today;
                if (daysDiff === 1) timeAgo = t.yesterday;
                else if (daysDiff > 1) timeAgo = `${daysDiff} ${t.daysAgo}`;
                
                return (
                  <div key={unit} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                      <div className="font-medium text-gray-900">{unit}</div>
                      <div className="text-sm text-gray-600">{masteredCount} cards mastered</div>
                    </div>
                    <div className="text-xs text-gray-500">{timeAgo}</div>
                  </div>
                );
              })}
              {flashcardsUnits.length === 0 && (
                <div className="text-center text-gray-500 py-8">
                  {t.noActivity}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* TOPIK Level Estimate */}
        <div className="mt-6 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl border border-gray-100 shadow-sm p-6 text-white">
          <div className="flex items-center justify-between">
            <div>
              <h3 className="text-lg font-semibold mb-2">{t.topikLevel}</h3>
              <div className="text-3xl font-bold">
                {profile?.level && profile.level >= 10 ? 'TOPIK II' : 'TOPIK I'}
              </div>
              <div className="text-sm opacity-80 mt-1">
                Based on your XP and progress
              </div>
            </div>
            <div className="text-6xl opacity-20">
              üéØ
            </div>
          </div>
        </div>
          ) : (
            <div className="mt-5 grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
              {flashcardsUnits.slice(0, 6).map((u) => {
                const percent = u.total ? Math.round((u.masteredCount / u.total) * 100) : 0;

                return (
                  <div key={u.unit} className="rounded-2xl border border-gray-100 bg-gray-50 p-4">
                    <div className="flex items-center justify-between gap-3">
                      <div className="font-bold text-gray-900">{u.unit}</div>
                      <div className="text-xs font-semibold text-gray-600">{percent}%</div>
                    </div>
                    <div className="mt-2 h-2 w-full bg-gray-200 rounded-full overflow-hidden">
                      <div className="h-full bg-green-600" style={{ width: `${percent}%` }} />
                    </div>
                    <div className="mt-2 text-xs text-gray-600">
                      {u.masteredCount} / {u.total} mastered
                    </div>

                    <div className="mt-3">
                      <Link
                        href={`/flashcards?unit=${encodeURIComponent(u.unit)}`}
                        className="text-sm font-semibold text-blue-700 hover:text-blue-800 transition"
                      >
                        {t.continue}
                      </Link>
                    </div>
                  </div>
                );
              })}
            </div>
          )}

          <div className="mt-5">
            <Link href="/exercises/vocabulary" className="text-sm font-semibold text-blue-700 hover:text-blue-800 transition">
              Open vocabulary exercises
            </Link>
          </div>
        </div>
      </header>

      <section className="max-w-6xl mx-auto px-6 py-10">
        <div className="bg-white rounded-2xl border border-gray-100 shadow-sm p-6">
          <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h1 className="text-2xl font-bold text-gray-900">{t.dashboardTitle}</h1>
              <p className="mt-1 text-gray-600">
                {plan === 'premium' ? t.dashboardDescPremium : t.dashboardDescFree}
              </p>
            </div>

            {plan === 'free' && (
              <button
                type="button"
                className="bg-blue-700 hover:bg-blue-800 text-white px-5 py-3 rounded-xl font-bold transition transform hover:-translate-y-1 active:translate-y-0 active:scale-[0.98]"
              >
                {t.upgrade}
              </button>
            )}
          </div>
        </div>

        <div className="mt-10">
          <div className="text-sm font-semibold text-gray-800 mb-4">{t.activities}</div>
          <div className="flex flex-wrap gap-4">
            {activities.map((a) => (
              <button
                key={a.title}
                type="button"
                onClick={() => {
                  if (a.icon === 'book') {
                    router.push('/exercises/vocabulary');
                    return;
                  }
                }}
                className="bg-white text-gray-900 hover:bg-gray-50 px-5 py-4 rounded-2xl shadow-sm hover:shadow-md transition border border-gray-100 inline-flex items-start gap-3 min-w-[240px] flex-1 transform hover:-translate-y-1 active:translate-y-0 active:scale-[0.98]"
              >
                <span className="mt-0.5 text-blue-700">{renderIcon(a.icon)}</span>
                <span className="text-left">
                  <span className="block font-bold">{a.title}</span>
                  <span className="block text-sm text-gray-600 mt-1">
                    {plan === 'premium' ? t.unlimited : a.limitKey ? t[a.limitKey] : ''}
                  </span>
                </span>
              </button>
            ))}
          </div>
        </div>
      </section>
    </main>
  );
}
